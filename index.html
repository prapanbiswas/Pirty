<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>LuminaParty</title>
    
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script src="https://unpkg.com/meyda/dist/web/meyda.min.js"></script>

    <style>
        :root {
            --bg-color: #000000;
            --panel-bg: #1a1a1a;
            --text-color: #e0e0e0;
            --accent: #00ff88;
            --accent-dim: #004422;
            --danger: #ff4444;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body {
            margin: 0;
            padding: 0;
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            overflow: hidden; /* Prevent scrolling */
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* UTILS */
        .hidden { display: none !important; }
        .full-screen { width: 100%; height: 100%; position: absolute; top: 0; left: 0; }
        
        /* ICONS (SVG) */
        .icon { width: 24px; height: 24px; fill: currentColor; }

        /* VIEWS */
        #landing-view, #host-view, #client-view {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: opacity 0.3s;
        }

        /* LANDING */
        .logo { font-size: 2rem; font-weight: bold; margin-bottom: 2rem; color: var(--accent); letter-spacing: 2px; }
        .btn {
            background: var(--panel-bg);
            border: 1px solid var(--accent);
            color: var(--accent);
            padding: 15px 30px;
            margin: 10px;
            border-radius: 8px;
            font-size: 1.1rem;
            cursor: pointer;
            width: 200px;
            text-transform: uppercase;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            transition: background 0.2s;
        }
        .btn:active { background: var(--accent-dim); }
        input[type="text"] {
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #444;
            background: #222;
            color: white;
            font-size: 1.1rem;
            text-align: center;
            width: 200px;
            margin-bottom: 10px;
        }

        /* HOST DASHBOARD */
        #host-dashboard {
            width: 100%;
            max-width: 500px;
            padding: 20px;
            background: rgba(20, 20, 20, 0.9);
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .header-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #333;
            padding-bottom: 10px;
        }
        .room-code { font-family: monospace; font-size: 1.2rem; color: var(--accent); cursor: pointer;}
        
        .control-group {
            background: #2a2a2a;
            padding: 15px;
            border-radius: 8px;
        }
        .control-label { font-size: 0.8rem; color: #888; margin-bottom: 8px; display: block; text-transform: uppercase;}

        .color-picker-wrapper { display: flex; gap: 10px; justify-content: space-between; }
        input[type="color"] { 
            width: 100%; height: 50px; border: none; cursor: pointer; background: none; 
        }

        .mode-toggles { display: flex; gap: 5px; }
        .mode-btn {
            flex: 1;
            padding: 10px;
            background: #333;
            border: none;
            color: #888;
            border-radius: 4px;
            cursor: pointer;
            display: flex; justify-content: center; align-items: center;
        }
        .mode-btn.active { background: var(--accent); color: black; }

        input[type="range"] { width: 100%; accent-color: var(--accent); }

        /* CLIENT VIEW */
        #client-bg {
            transition: background-color 0.05s linear; /* Fast transition */
            z-index: 0;
        }
        #client-overlay {
            z-index: 10;
            background: rgba(0,0,0,0.7);
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            pointer-events: none; /* Let taps pass through to bg */
        }
    </style>
</head>
<body>

    <div id="landing-view">
        <div class="logo">LUMINAPARTY</div>
        <button class="btn" onclick="initHost()">
            <svg class="icon" viewBox="0 0 24 24"><path d="M4 6h16v12H4zM20 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2z"/></svg>
            Create Party
        </button>
        <div style="height: 20px;"></div>
        <input type="text" id="join-id-input" placeholder="Enter Room ID" maxlength="4">
        <button class="btn" onclick="initClient()">
            <svg class="icon" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z"/></svg>
            Join Party
        </button>
    </div>

    <div id="host-view" class="hidden">
        <div id="host-dashboard">
            <div class="header-bar">
                <span>HOST PANEL</span>
                <span class="room-code" id="host-room-id" onclick="copyToClipboard()">Loading...</span>
            </div>

            <div class="control-group">
                <span class="control-label">Mode</span>
                <div class="mode-toggles">
                    <button class="mode-btn active" id="btn-manual" onclick="setMode('manual')">
                        <svg class="icon" viewBox="0 0 24 24"><path d="M9 11.75c-.69 0-1.25.56-1.25 1.25s.56 1.25 1.25 1.25 1.25-.56 1.25-1.25-.56-1.25-1.25-1.25zm6 0c-.69 0-1.25.56-1.25 1.25s.56 1.25 1.25 1.25 1.25-.56 1.25-1.25-.56-1.25-1.25-1.25zM12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8 0-.29.02-.58.05-.86 2.36-1.05 4.23-2.98 5.21-5.37C11.07 8.33 14.05 10 17.42 10c.78 0 1.53-.09 2.25-.26.21 1.01.33 2.05.33 3.1 0 3.95-3.21 7.16-7.16 7.16z"/></svg>
                    </button>
                    <button class="mode-btn" id="btn-audio" onclick="setMode('audio')">
                        <svg class="icon" viewBox="0 0 24 24"><path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3z"/><path d="M17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"/></svg>
                    </button>
                    <button class="mode-btn" id="btn-strobe" onclick="setMode('strobe')">
                        <svg class="icon" viewBox="0 0 24 24"><path d="M7 2v11h3v9l7-12h-4l4-8z"/></svg>
                    </button>
                </div>
            </div>

            <div id="ctrl-manual" class="control-group">
                <span class="control-label">Master Color</span>
                <input type="color" id="color-picker" value="#00ff88">
            </div>

            <div id="ctrl-audio" class="control-group hidden">
                <span class="control-label">Mic Sensitivity</span>
                <input type="range" id="mic-sens" min="0" max="100" value="50">
            </div>

            <div id="ctrl-strobe" class="control-group hidden">
                <span class="control-label">Strobe Speed</span>
                <input type="range" id="strobe-speed" min="50" max="500" value="200" style="direction: rtl"> </div>

            <div class="control-group">
                 <span class="control-label">System</span>
                 <button class="btn" style="width:100%" onclick="toggleFullScreen()">
                    <svg class="icon" viewBox="0 0 24 24"><path d="M7 14H5v5h5v-2H7v-3zm-2-4h2V7h3V5H5v5zm12 7h-3v2h5v-5h-2v3zM14 5v2h3v3h2V5h-5z"/></svg>
                    Fullscreen
                 </button>
            </div>
        </div>
    </div>

    <div id="client-view" class="hidden">
        <div id="client-bg" class="full-screen"></div>
        <div id="client-overlay">
            <h2 id="client-status">Connecting...</h2>
            <p>Double tap to toggle Fullscreen</p>
        </div>
    </div>

    <script>
        // --- GLOBAL STATE ---
        let peer = null;
        let connections = []; // For Host
        let hostConn = null;  // For Client
        let currentMode = 'manual';
        let packetId = 0;
        let lastReceivedId = 0;
        let audioCtx, analyzer, meydaAnalyzer;
        let strobeInterval = null;

        // --- DOM ELEMENTS ---
        const views = {
            landing: document.getElementById('landing-view'),
            host: document.getElementById('host-view'),
            client: document.getElementById('client-view')
        };
        const controls = {
            manual: document.getElementById('ctrl-manual'),
            audio: document.getElementById('ctrl-audio'),
            strobe: document.getElementById('ctrl-strobe')
        };

        // --- NAVIGATION & UI ---
        function showView(viewName) {
            Object.values(views).forEach(v => v.classList.add('hidden'));
            views[viewName].classList.remove('hidden');
        }

        function setMode(mode) {
            currentMode = mode;
            // Update Buttons
            document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(`btn-${mode}`).classList.add('active');
            
            // Show/Hide Controls
            Object.values(controls).forEach(c => c.classList.add('hidden'));
            if(controls[mode]) controls[mode].classList.remove('hidden');

            // Logic Triggers
            if (mode === 'audio') startAudioEngine();
            else stopAudioEngine();

            if (mode === 'strobe') startStrobe();
            else stopStrobe();
        }

        // --- FULLSCREEN LOGIC ---
        function toggleFullScreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen().catch(err => console.log(err));
            } else {
                document.exitFullscreen();
            }
        }
        
        // Double tap listener
        let lastTap = 0;
        document.addEventListener('touchend', function(e) {
            const currentTime = new Date().getTime();
            const tapLength = currentTime - lastTap;
            if (tapLength < 500 && tapLength > 0) {
                toggleFullScreen();
                // If client, hide overlay
                const overlay = document.getElementById('client-overlay');
                if(overlay) overlay.style.opacity = (overlay.style.opacity === '0') ? '1' : '0';
                e.preventDefault();
            }
            lastTap = currentTime;
        });

        // --- HOST LOGIC ---
        function initHost() {
            showView('host');
            
            // Create random 4-char ID
            const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
            let id = '';
            for (let i = 0; i < 4; i++) id += chars.charAt(Math.floor(Math.random() * chars.length));
            
            peer = new Peer(id); // Use default PeerJS server

            peer.on('open', (id) => {
                document.getElementById('host-room-id').innerText = "ROOM: " + id;
            });

            peer.on('connection', (conn) => {
                connections.push(conn);
                console.log('Client connected');
            });
            
            // Manual Color Listener
            document.getElementById('color-picker').addEventListener('input', (e) => {
                if(currentMode === 'manual') broadcastColor(e.target.value);
            });
        }

        function broadcastColor(hex) {
            packetId++;
            const data = { id: packetId, color: hex };
            
            // Loop through all connected clients and send
            connections.forEach(conn => {
                if (conn.open) {
                    conn.send(data); // Send JSON object directly
                }
            });

            // Update Host UI too (optional visual feedback)
            // document.body.style.backgroundColor = hex; 
        }

        // --- AUDIO ENGINE (Meyda) ---
        async function startAudioEngine() {
            if (audioCtx) return; // Already running

            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                const source = audioCtx.createMediaStreamSource(stream);
                
                meydaAnalyzer = Meyda.createMeydaAnalyzer({
                    audioContext: audioCtx,
                    source: source,
                    bufferSize: 512,
                    featureExtractors: ['energy'],
                    callback: (features) => {
                        const sensitivity = document.getElementById('mic-sens').value / 10; // 0 to 10
                        const energy = features.energy;
                        const threshold = 11 - sensitivity; // Invert: High sens = Low threshold

                        if (energy > threshold) {
                            // On Beat: Flash Color
                            const beatColor = document.getElementById('color-picker').value;
                            broadcastColor(beatColor);
                        } else {
                            // Off Beat: Black
                            broadcastColor('#000000');
                        }
                    }
                });
                meydaAnalyzer.start();
            } catch (err) {
                alert("Microphone access denied or error: " + err);
                setMode('manual');
            }
        }

        function stopAudioEngine() {
            if (meydaAnalyzer) meydaAnalyzer.stop();
        }

        // --- STROBE ENGINE ---
        function startStrobe() {
            let on = false;
            stopStrobe(); // Clear existing
            
            function runLoop() {
                if(currentMode !== 'strobe') return;
                
                const speed = document.getElementById('strobe-speed').value; // ms
                const color = document.getElementById('color-picker').value;
                
                on = !on;
                broadcastColor(on ? color : '#000000');
                
                strobeInterval = setTimeout(runLoop, speed);
            }
            runLoop();
        }

        function stopStrobe() {
            if (strobeInterval) clearTimeout(strobeInterval);
        }


        // --- CLIENT LOGIC ---
        function initClient() {
            const roomId = document.getElementById('join-id-input').value.toUpperCase();
            if(roomId.length < 1) return alert("Enter Room ID");

            showView('client');
            
            peer = new Peer(); // Auto generated ID

            peer.on('open', (id) => {
                document.getElementById('client-status').innerText = "Connecting to " + roomId + "...";
                
                // Connect to Host
                const conn = peer.connect(roomId, {
                    reliable: false, // UDP Mode (Fire and Forget)
                    serialization: 'json'
                });

                conn.on('open', () => {
                    document.getElementById('client-status').innerText = "CONNECTED";
                    setTimeout(() => {
                         // Fade out overlay
                         document.getElementById('client-overlay').style.opacity = '0';
                    }, 2000);
                });

                conn.on('data', (data) => {
                    // Packet Dropping Logic
                    if (data.id > lastReceivedId) {
                        lastReceivedId = data.id;
                        document.getElementById('client-bg').style.backgroundColor = data.color;
                    }
                });
                
                conn.on('close', () => alert("Host disconnected"));
            });
        }

        function copyToClipboard() {
            const code = document.getElementById('host-room-id').innerText.replace("ROOM: ", "");
            navigator.clipboard.writeText(code);
            alert("Room Code Copied!");
        }

    </script>
</body>
                      </html>

